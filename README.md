# 💖 HeartCore (心芯) v1.0.0

**一个具有精力、记忆、情感和主动性的 AI 灵魂。**

HeartCore (心芯) 是一个为 AstrBot设计的“一体化”高级回复插件。它的设计目标是让 AI 摆脱“有问必答”的工具属性，使其成为一个真正“活”在群聊中的成员。

它拥有一个复杂的内部状态系统，使其能够：
* **感知精力**：在“累”的时候减少发言，在“精力充沛”时更积极。
* **拥有情绪**：会因为对话内容而“开心”或“沮丧”，并影响回复风格。
* **记住群友**：独创的“社交记忆”系统，会区分“朋友”、“熟人”和“回避对象”，非记忆功能。
* **主动发起**：会在群聊“沉寂”时主动发起话题。

本项目是对多个优秀插件理念的融合与致敬，包括 `Heartflow`、`SpectreCore`、`Meme Manager` 和 `LLM Poke`，并在此基础上构建了更统一、更强大的功能。

---

## ✨ 核心功能

* **🧠 双层判断架构**:
    * **判断模型 (小模型)**: 使用轻量级模型（或 `general_small_model_pool`）对*每一条*消息进行快速评分，决定是否要回应。
    * **回复模型 (主模型)**: 仅在“判断通过”时，才调用 AstrBot 的主模型（你配置的昂贵大模型）生成高质量回复。
* **⚡ 精力与心情系统**:
    * AI 拥有 `精力 (Energy)` 和 `心情 (Mood)`。回复会消耗精力，不回复则会恢复精力。
    * 负面消息会降低心情，积极消息会提升心情。
* **🫂 独创社交记忆 (v4.3+)**:
    * 启用 `enable_user_profiles` 后，AI 会开始“记人”。
    * 它会为每个用户计算 `社交分数 (Social Score)`。
    * 根据分数，用户会被划分为不同**关系层级 (Tier)**：`friend` (朋友), `acquaintance` (熟人), `stranger` (陌生人), `avoiding` (回避对象)。
* **🎭 动态风格指南 (v10.12 更新)**:
    * AI 的回复风格**不再是一成不变的**。
    * **(v10.12 架构变更)**：AI 的回复风格现在**只受 `心情 (Mood)` 影响**。`精力`和`社交关系`仅用于“判断模型”（决定是否回复），而**不会**影响回复的*内容*，以防止对“陌生人”或在“精力低”时回复得过于冷漠。
* **🗣️ 主动话题 (Proactive Chat)**:
    * 当群聊沉寂一段时间，且 AI 精力充沛时，它会主动发起一个话题来活跃气氛。
* **💾 一致的上下文 (v10.13 更新)**:
    * AI 会自动保存上下文，实现短期上下文记忆。
    * **(v10.13 架构变更)**：历史记录的长度现在**严格**由 `context_messages_count` 配置项控制。“判断模型”和“回复模型”将看到完全相同数量的历史消息。
* **😂 智能表情包 (Meme Manager 融合)**:
    * 启用 `enable_emotion_sending` 后，AI 会在回复后，根据回复内容的“情绪” (happy, sad, angry...) 自动发送匹配的表情包。
* **👉 戳一戳响应 (LLM Poke 融合)**:
    * 启用 `enable_poke_response` 后，被戳时 AI 会 50% 概率“戳回去”，50% 概率调用 LLM 进行文本回复。
    * 文本回复会获得**奖励分**，确保被响应。
* **👀 昵称感知**:
    * 在群里喊 AI 的昵称（需配置 `bot_nicknames`），会触发**奖励分**，使其几乎必定回应你。
* **🖼️ 图片识别 (VL)**:
    * 启用 `enable_image_recognition` 后，AI 能“看到”图片内容并将其纳入对话历史（*注意：默认仅在 `single` 模式下开启以节约 API*）。
* **☁️ API 弹性**:
    * 所有对小模型（判断、表情、摘要、主动）的 API 调用均已实现**弹性化** (基于 `api_utils.py`)。
    * 单个模型 API 失败（如超时或 500）会自动切换到 `general_small_model_pool` 中的下一个可用模型，极大提升了插件的稳定性。

---

## 📖 AI 是如何思考的？ (v10.12 架构)

`HeartCore` 的所有行为都由一个**两阶段**的逻辑驱动：

### 阶段 1：判断 (是否回复？)
AI 会综合考虑以下所有状态，来决定*是否*要回应这条消息：

1.  **精力 (Energy)**:
    * AI 回复消息会消耗精力。
    * AI 判断后决定不回复，会恢复少量精力。
    * 精力过低时，AI 会变得“疲倦”，**降低回复意愿**，倾向于“潜水”。
2.  **社交分数 (Social Score)**:
    * 你与 AI 的每一次互动都会被计分。
    * 你的**关系层级** (`friend`, `stranger`...) 会影响 AI 的**回复意愿**。AI 可能会更倾向于回复“朋友”，而回避“回避对象”。
3.  **心情 (Mood)**:
    * AI 会评估收到的消息是 `positive` 还是 `negative`。
    * **心情**同样会影响 AI 的**回复意愿**。

### 阶段 2：回复 (回复什么？)
如果 AI 在阶段 1 中决定要回复，它将进入阶段 2 来生成*回复的内容*。

**(v10.12 架构更新)**：在此阶段，AI 的回复风格**只受 `心情 (Mood)` 影响**。

* **心情 (Mood)**:
    * 心情值会**直接影响**它的回复风格（例如，沮丧时更冷淡，开心时更热情）。
    * `精力`和`社交分数`**不会**影响回复的*内容*，这确保了 AI 即使在“精力不足”或面对“陌生人”时，也能给出符合其人设和当前心情的、高质量的回复。

---

### 社交分数是如何计算的？
* **积极互动** (AI 回复了你): `+1.0` 分 (可配置 `score_positive_interaction`)。
* **消极互动** (AI 认为你的消息是负面的且不回复): `-1.5` 分 (可配置 `score_negative_interaction`)。
* **关系衰减**: 如果你长时间不和 AI 说话 (默认 3 天)，你们的分数会每天自动减少。
* **最终层级**: 你的总分决定了 AI 如何“看待”你（`friend`, `acquaintance`, `stranger`, `avoiding`），这会影响它在【阶段 1】中对你的**回复意愿**。

---

## 🚀 快速开始：配置


### 1. 关键配置 (必看)
安装后，请**务必**在 AstrBot WebUI 的“插件管理”中，点击 `heartcore` 的**配置**按钮，完成以下设置：

1.  **【总开关】**
    * `enable_heartflow`: **必须**勾选此项以启用插件。

2.  **【模型配置 (最重要)】**
    * `general_small_model_pool`: **(必填)** 全局小模型池。这是 HeartCore 的“主力”，用于**判断、表情、摘要、主动话题**等所有弹性 API 调用。
    * *建议*: 填入 1-3 个你已配置的、便宜的、高速的小模型 (例如 `gemma-2b`, `qwen-turbo` 等)。
    * `judge_provider_names`: (可选) 专门用于“判断”的模型。如果留空，将自动使用上面的“全局小模型池”。
    * `summarize_provider_name`: (可选) 专门用于“人格摘要”的模型。如果留空，将自动使用“全局小模型池”中的第一个。

3.  **【功能开关】**
    * `enable_user_profiles`: **(推荐开启)** 启用“社交记忆”和“关系层级”系统。
    * `enable_emotion_sending`: **(推荐开启)** 启用 AI 自动发表情包功能。
    * `enable_poke_response`: **(推荐开启)** 启用戳一戳响应。
    * `proactive_enabled`: (可选) 启用“主动话题”功能。

4.  **【AI 行为调整】**
    * `reply_threshold`: (默认 0.6) AI 的“回复敏感度”。**调高**此值会让 AI 更“高冷”，**调低**则更“话痨”。
    * `force_reply_bonus_score`: (默认 0.5) 昵称和戳一戳的奖励分。保持默认值（0.5）几乎可以确保 AI 必定回应你（因为 0.5 + 基础分 > 0.6 阈值）。
    * `bot_nicknames`: **(推荐配置)** 填入 AI 的昵称 (例如 `["妃妃", "AI酱"]`)。当群友使用这些昵称时，AI 会获得奖励分。
    * `tier_friend_score`: (默认 50.0) 达到多少“社交分数”后，AI 会把你当“朋友”。

5. **【meme表情包配置】**
    * 参考Meme Manager的表情包配置项
    * 表情包路径同meme路径：AstrBot\data\memes_data\memes
    * `emotion_descriptions`:如果以前使用过meme则可以直接复制AstrBot\data\memes_data中json文件内容，没有使用过请按照默认表情包示例进行配置，请你现在表情包文件夹创建文件见并配置对应的表情
    * `tier_friend_score`: (默认 50.0) 达到多少“社交分数”后，AI 会把你当“朋友”。
---

## 🎮 可用指令

所有指令均在群聊中发送：

* `/heartcore`
    * 查看当前群聊的心流状态，包括精力、心情、判断模式，以及**你自己的社交状态**（你和 AI 的关系层级及分数）。
* `/重载心流`
    * 重置**当前群聊**的所有状态，包括精力、心情和计数器（**不会**重置社交分数）。
* `/查看缓存`
    * (v10+) 查看动态人格摘要 (Style Guide) 的缓存状态。
* `/清除缓存`
    * (v10+) 强制清除所有已生成的人格摘要，使其在下次使用时重新生成。

## 💬 致谢

本项目的功能实现离不开以下优秀插件的创意和架构启发：

* **Heartflow** (https://github.com/advent259141/Astrbot_plugin_Heartflow)
* **SpectreCore** (https://github.com/23q3/astrbot_plugin_SpectreCore)
* **Meme Manager** (https://github.com/anka-afk/astrbot_plugin_meme_manager)
